<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upload & Sinkron Data - Tracer Study</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }
    
    .navbar {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .upload-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .upload-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e9ecef;
    }
    
    .upload-header h4 {
      color: #0d6efd;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .upload-header p {
      color: #6c757d;
      margin: 0;
    }
    
    .form-check-input:checked {
      background-color: #0d6efd !important;
      border-color: #0d6efd !important;
    }
    
    .form-check-input:checked[type=checkbox] {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='white' d='M6.173 16.313l-4.8-4.8L3.76 9.12l2.414 2.414 7.657-7.657 2.387 2.387-10.045 10.05z'/%3e%3c/svg%3e") !important;
    }
    
    .btn-upload {
      background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
      border: none;
      padding: 12px 24px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }
    
    .btn-upload:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(13, 110, 253, 0.4);
    }
    
    .btn-upload:disabled {
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }
    
    .status-message {
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      border-left: 4px solid;
    }
    
    .status-success {
      background-color: #d1e7dd;
      border-left-color: #198754;
      color: #0f5132;
    }
    
    .status-error {
      background-color: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    
    .status-loading {
      background-color: #cff4fc;
      border-left-color: #0dcaf0;
      color: #055160;
    }
    
    .preview-table {
      margin-top: 1.5rem;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .preview-table table {
      margin: 0;
    }
    
    .preview-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
    }
    
    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .file-info {
      background-color: #f8f9fa;
      border-radius: 6px;
      padding: 0.75rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: #495057;
    }
    
    .breadcrumb {
      background: rgba(255,255,255,0.8);
      border-radius: 8px;
    }
  </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="javascript:void(0)" onclick="navigateToPage('Upload')">
      <i class="bi bi-mortarboard-fill me-2"></i>
      Tracer Study Vokasi
    </a>
    
    <div class="navbar-nav ms-auto">
      <a class="nav-link text-light active" href="javascript:void(0)" onclick="navigateToPage('Upload')">
        <i class="bi bi-cloud-upload me-1"></i>
        Upload & Sinkron Data
      </a>
      <a class="nav-link text-light" href="javascript:void(0)" onclick="navigateToPage('Index')">
        <i class="bi bi-broadcast me-1"></i>
        Broadcast WhatsApp
      </a>
    </div>
  </div>
</nav>

<!-- Breadcrumb -->
<div class="container mt-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="javascript:void(0)" onclick="navigateToPage('Upload')" class="text-decoration-none">
          <i class="bi bi-house me-1"></i>Home
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Upload & Sinkron Data</li>
    </ol>
  </nav>
</div>

<div class="container">
  <div class="upload-container">
    <div class="upload-header">
      <h4>üì§ Upload & Sinkronisasi Data Tracer Study</h4>
      <p>Upload file CSV atau XLSX untuk memperbarui data broadcast alumni</p>
    </div>

    <div class="mb-3">
      <label for="fileInput" class="form-label fw-semibold">Pilih File</label>
      <input type="file" id="fileInput" class="form-control form-control-lg" accept=".csv,.xlsx">
      <div class="file-info" id="fileInfo" style="display: none;"></div>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="skipHeader" style="width:1.2em; height:1.2em;">
      <label class="form-check-label fw-semibold ms-2" for="skipHeader">
        Lewati baris header (baris pertama)
      </label>
      <div class="form-text">Centang jika file memiliki header di baris pertama yang tidak perlu diimpor</div>
    </div>

    <div class="d-grid">
      <button class="btn btn-primary btn-upload btn-lg" onclick="uploadFile()" id="uploadBtn">
        üöÄ Upload & Sinkronkan Data
      </button>
    </div>

    <div id="status"></div>
    <div id="preview"></div>
  </div>
</div>

<script>
// Global variables
let isUploading = false;

// SOLUSI CLIENT-SIDE - Ganti function navigateToPage di Upload.html dan Index.html

function navigateToPage(page) {
  console.log('Starting navigation to:', page);
  
  // Show loading overlay
  showNavigationLoading(page);
  
  // Get current Web App URL from server
  google.script.run
    .withSuccessHandler(function(webAppUrl) {
      console.log('Got Web App URL from server:', webAppUrl);
      
      if (webAppUrl) {
        // Use server-provided URL
        const targetUrl = webAppUrl + '?page=' + page;
        console.log('Navigating to:', targetUrl);
        window.location.href = targetUrl;
      } else {
        // Fallback: try to construct URL from current location
        handleNavigationFallback(page);
      }
    })
    .withFailureHandler(function(error) {
      console.error('Failed to get Web App URL:', error);
      handleNavigationFallback(page);
    })
    .getCurrentWebAppUrl();
}

function showNavigationLoading(page) {
  const pageNames = {
    'Upload': 'Upload & Sinkron Data',
    'Index': 'Broadcast WhatsApp'
  };
  
  const pageName = pageNames[page] || page;
  
  // Remove existing loading if any
  const existingLoading = document.getElementById('navigationLoading');
  if (existingLoading) {
    existingLoading.remove();
  }
  
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'navigationLoading';
  loadingDiv.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); color: white; 
                display: flex; align-items: center; justify-content: center; 
                z-index: 9999; font-family: Arial;">
      <div style="text-align: center;">
        <div style="font-size: 18px; margin-bottom: 10px;">
          Membuka halaman ${pageName}...
        </div>
        <div style="width: 40px; height: 40px; border: 4px solid #fff; 
                    border-top: 4px solid transparent; border-radius: 50%; 
                    animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
          Mendapatkan URL aplikasi...
        </div>
      </div>
    </div>
    <style>
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  `;
  
  document.body.appendChild(loadingDiv);
}

function handleNavigationFallback(page) {
  console.log('Using navigation fallback for page:', page);
  
  const pageNames = {
    'Upload': 'Upload & Sinkron Data',
    'Index': 'Broadcast WhatsApp'
  };
  
  const pageName = pageNames[page] || page;
  
  // Remove loading
  const loadingDiv = document.getElementById('navigationLoading');
  if (loadingDiv) {
    loadingDiv.remove();
  }
  
  // Try different URL construction methods
  let targetUrl = null;
  
  // Method 1: Check if current URL is valid production URL
  const currentUrl = window.location.href;
  if (currentUrl.includes('script.google.com/macros') && currentUrl.includes('/exec')) {
    const baseUrl = currentUrl.split('?')[0]; // Remove query parameters
    targetUrl = baseUrl + '?page=' + page;
  }
  
  // Method 2: Check referrer
  if (!targetUrl && document.referrer && document.referrer.includes('script.google.com/macros')) {
    const referrerUrl = new URL(document.referrer);
    targetUrl = referrerUrl.origin + referrerUrl.pathname + '?page=' + page;
  }
  
  if (targetUrl) {
    console.log('Fallback navigation to:', targetUrl);
    window.location.href = targetUrl;
  } else {
    // Last resort: show manual navigation
    showManualNavigation(page, pageName);
  }
}

function showManualNavigation(page, pageName) {
  const modalDiv = document.createElement('div');
  modalDiv.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); color: white; 
                display: flex; align-items: center; justify-content: center; 
                z-index: 9999; font-family: Arial;">
      <div style="background: white; color: black; padding: 20px; border-radius: 10px; 
                  max-width: 500px; text-align: center;">
        <h3>Navigasi Manual</h3>
        <p>Tidak dapat navigasi otomatis ke halaman ${pageName}.</p>
        <p>Silakan reload halaman dengan parameter:</p>
        <div style="background: #f5f5f5; padding: 10px; margin: 10px 0; 
                    border-radius: 5px; font-family: monospace;">
          ?page=${page}
        </div>
        <button onclick="window.location.reload()" 
                style="background: #007bff; color: white; border: none; 
                       padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
          Reload Halaman
        </button>
        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                style="background: #6c757d; color: white; border: none; 
                       padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
          Tutup
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modalDiv);
}


// File input change handler
document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const fileInfo = document.getElementById('fileInfo');
  
  if (file) {
    const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
    const fileType = file.type || 'Unknown';
    
    fileInfo.innerHTML = `
      <strong>File:</strong> ${file.name}<br>
      <strong>Ukuran:</strong> ${fileSize} MB<br>
      <strong>Tipe:</strong> ${fileType}
    `;
    fileInfo.style.display = 'block';
    
    // Clear previous results
    document.getElementById('status').innerHTML = '';
    document.getElementById('preview').innerHTML = '';
  } else {
    fileInfo.style.display = 'none';
  }
});

function uploadFile() {
  if (isUploading) return;
  
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  
  if (!fileInput.files.length) {
    showStatus("Silakan pilih file terlebih dahulu!", "error");
    return;
  }

  const file = fileInput.files[0];
  
  // Validate file size (max 10MB)
  if (file.size > 10 * 1024 * 1024) {
    showStatus("File terlalu besar! Maksimal 10MB.", "error");
    return;
  }
  
  // Validate file type
  const allowedTypes = ['.csv', '.xlsx'];
  const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
  if (!allowedTypes.includes(fileExtension)) {
    showStatus("Format file tidak didukung! Gunakan CSV atau XLSX.", "error");
    return;
  }

  isUploading = true;
  
  // Update button state
  uploadBtn.disabled = true;
  uploadBtn.innerHTML = '<span class="spinner me-2"></span>Mengupload...';
  
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const base64 = e.target.result.split(',')[1];
      const fileObj = { 
        name: file.name, 
        mimeType: file.type || 'application/octet-stream', 
        data: base64 
      };
      const options = { 
        skipHeader: document.getElementById('skipHeader').checked 
      };

      showStatus("‚è≥ Memproses file...", "loading");

      // Call server-side function
      google.script.run
        .withSuccessHandler(handleUploadSuccess)
        .withFailureHandler(handleUploadError)
        .processUpload(fileObj, options);
        
    } catch (error) {
      handleUploadError(error);
    }
  };
  
  reader.onerror = function() {
    handleUploadError(new Error("Gagal membaca file"));
  };
  
  reader.readAsDataURL(file);
}

function handleUploadSuccess(result) {
  console.log('Upload success:', result);
  
  isUploading = false;
  const uploadBtn = document.getElementById('uploadBtn');
  uploadBtn.disabled = false;
  uploadBtn.innerHTML = 'üöÄ Upload & Sinkronkan Data';
  
  showStatus(result.message, "success");
  
  // Show additional info
  const additionalInfo = `
    <div class="mt-2 small">
      <strong>Detail:</strong><br>
      ‚Ä¢ Sumber: ${result.source}<br>
      ‚Ä¢ Baris diproses: ${result.rows}<br>
      ‚Ä¢ Range target: ${result.targetRange}<br>
      ‚Ä¢ Waktu sinkron: ${result.lastSync}
    </div>
  `;
  
  document.getElementById('status').innerHTML += additionalInfo;
  
  // Load and show preview
  loadPreviewData();
  
  // Show success message with navigation option
  setTimeout(() => {
    if (confirm(`Upload berhasil! ${result.rows} baris data telah diproses.\n\nIngin langsung ke halaman Broadcast untuk mengirim pesan?`)) {
      navigateToPage('Index');
    }
  }, 2000);
}

function handleUploadError(error) {
  console.error('Upload error:', error);
  
  isUploading = false;
  const uploadBtn = document.getElementById('uploadBtn');
  uploadBtn.disabled = false;
  uploadBtn.innerHTML = 'üöÄ Upload & Sinkronkan Data';
  
  const errorMessage = error.message || error.toString() || "Terjadi kesalahan saat upload";
  showStatus(`‚ùå Upload gagal: ${errorMessage}`, "error");
}

function loadPreviewData() {
  google.script.run
    .withSuccessHandler(function(data) {
      if (!data || !data.length) {
        document.getElementById('preview').innerHTML = `
          <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle me-2"></i>
            Tidak ada data untuk ditampilkan
          </div>
        `;
        return;
      }

      let html = `
        <div class="preview-table">
          <h6 class="mb-3">üëÄ Preview Data (10 baris teratas)</h6>
          <div class="table-responsive">
            <table class="table table-sm table-striped table-bordered mb-0">
              <thead class="table-light">
                <tr>`;
                
      // Header
      html += data[0].map(h => `<th class="text-center">${h}</th>`).join("");
      html += `</tr></thead><tbody>`;
      
      // Data rows
      data.slice(1).forEach((row, index) => {
        html += `<tr>`;
        html += row.map(cell => `<td>${cell || '-'}</td>`).join("");
        html += `</tr>`;
      });
      
      html += `</tbody></table>
          </div>
          <div class="text-end mt-2">
            <small class="text-muted">
              Menampilkan maksimal 10 baris pertama dari data yang diupload
            </small>
          </div>
        </div>
      `;
      
      document.getElementById('preview').innerHTML = html;
    })
    .withFailureHandler(function(error) {
      console.warn('Failed to load preview:', error);
      document.getElementById('preview').innerHTML = `
        <div class="alert alert-warning mt-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Gagal memuat preview data
        </div>
      `;
    })
    .getPreviewData();
}

function showStatus(message, type) {
  const statusEl = document.getElementById('status');
  const statusClass = {
    'success': 'status-success',
    'error': 'status-error', 
    'loading': 'status-loading'
  }[type] || 'status-loading';
  
  const icon = {
    'success': '‚úÖ',
    'error': '‚ùå',
    'loading': '‚è≥'
  }[type] || '‚ÑπÔ∏è';
  
  statusEl.innerHTML = `
    <div class="status-message ${statusClass}">
      ${icon} ${message}
    </div>
  `;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  console.log('Upload page initialized');
  
  // Load initial preview if data exists
  loadPreviewData();
  
  // Expose functions globally for parent access
  window.uploadFile = uploadFile;
  window.loadPreviewData = loadPreviewData;
});

// Handle file drop
const fileInput = document.getElementById('fileInput');
const uploadContainer = document.querySelector('.upload-container');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  uploadContainer.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
  uploadContainer.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
  uploadContainer.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
  uploadContainer.style.backgroundColor = '#f8f9fa';
  uploadContainer.style.borderColor = '#0d6efd';
}

function unhighlight(e) {
  uploadContainer.style.backgroundColor = '';
  uploadContainer.style.borderColor = '';
}

uploadContainer.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  
  if (files.length > 0) {
    fileInput.files = files;
    fileInput.dispatchEvent(new Event('change'));
  }
}

console.log('Upload page loaded successfully');
</script>

</body>
</html>
